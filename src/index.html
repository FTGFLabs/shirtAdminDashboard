<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Simple Sheet Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
        :root {
            --main-bg-color: #f5f5f5; /* Light gray background for the body */
            --card-bg-color: #fff; /* White background for the cards */
            --text-color: #333333;
            --input-border-color: #ddd;
            --input-bg-color: #fcfcfc;
            --button-bg-color: #0e0e0e; /* Dark gray for add buttons */
            --button-text-color: #fff;
            --header-icon-color: #555;
            --placeholder-color: #999;
        }
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        h2 {
          font-size: 20px;
        }
        body{
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column; /* Changed to column to accommodate header text */
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--main-bg-color);
            color: var(--text-color);
        }
        .toast {
          visibility: hidden;
          min-width: 250px;
          background-color: #333;
          color: #fff;
          text-align: center;
          border-radius: 8px;
          padding: 12px 24px;
          position: fixed;
          z-index: 999;
          left: 50%;
          transform: translateX(-50%);
          font-size: 16px;
          box-shadow: 0 4px 10px rgba(0,0,0,0.3);
          opacity: 0;
          transition: opacity 0.5s ease-in-out, bottom 0.5s;
        }
        .toast.show {
          visibility: visible;
          opacity: 1;
          top: 30px;
        }
        .toast.success {
          background-color: #4CAF50;
        }
        .toast.error {
          background-color: #f44336;
        }
        .toast.info {
          background-color: #2196F3;
        }


        .container{
            width: 1200px; /* Adjusted width for dashboard */
            max-width: 95%;
            display: flex; /* Kept for the main dashboard layout */
            flex-direction: column; /* Changed to column to stack nav and warp-container */
            align-items: center;
        }
        .nav{
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            width: 100%; /* Ensure nav spans full width of container */
        }
        .nav h1 {
            font-size: 24px;
            color: var(--text-color);
        }
        .warp-container{
            display: flex;
            justify-content: space-between;
            gap: 25px; /* Space between the left container and the new card group */
            width: 100%; /* Ensure warp-container spans full width */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            height: 90vh;
        }
      

        .right-container { /* New container for the two cards on the right */
            display: flex;
            flex-direction: column;
            height: 100%;
            flex: 1;
            gap: 25px;
            width: 500px;
        }

        /* search */
        .search-card{
          background-color: var(--card-bg-color);
          border-radius: 8px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
          flex-direction: column; /* Stack cards vertically */
          gap: 25px; /* Space between the two cards */
          display: flex;
          flex-direction: column;
          padding: 20px;
        }
        .search-box{
          display: flex;
          flex-direction: column;
          gap: 6px;
        }

        form{
          display: flex;
          gap: 10px;
        }
        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border-color);
            border-radius: 5px;
            font-size: 16px;
            color: var(--text-color);
            background-color: var(--input-bg-color);
            outline: none;
        }

        input[type="text"]::placeholder,
        select option[value=""] {
            color: var(--placeholder-color);
        }
        .submit-btn{
          font-size: 18px;
          border-radius: 5px;
          background-color: var(--button-bg-color);
          color: var(--button-text-color);
          border: none;
          padding: 10px;
        }

        /* info card */
        .info-card{
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            background-color: var(--card-bg-color);
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            height: 80vh;
            align-items: stretch;
        }
        .info-card::-webkit-scrollbar {
          width: 8px;
        }
        .info-card::-webkit-scrollbar-thumb {
          background-color: rgba(0, 0, 0, 0.2);
          border-radius: 4px;
        }

        .detail-content h2 {
          text-align: center;
          margin-bottom: 16px;
          font-size: 20px;
          color: #333;
          border-bottom: 2px solid #eee;
          padding-bottom: 8px;
        }

        .student-items  {
          display: flex;
          flex-direction: column;
          gap: 12px;
        }

        .detail-item {
          font-size: 18px;
          color: #444;
        }

        .detail-item strong {
          color: #111;
        }
        .student-details{
          font-size: 18px;
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .status-control {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }

        .status-control label {
          font-size: 18px;
          margin-bottom: 4px;
          color: #333;
        }

        .status-control select {
          padding: 10px;
          border-radius: 6px;
          border: 1px solid #ccc;
          font-size: 15px;
          background-color: #f9f9f9;
          appearance: none;
        }

        .status-control button {
          padding: 10px;
          background-color: #007bff;
          color: white;
          font-size: 15px;
          border: none;
          border-radius: 6px;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .status-control button:hover {
          background-color: #0056b3;
        }
        .problem-textarea {
          margin-top: 10px;
          padding: 10px;
          border: 1px solid #ccc;
          border-radius: 6px;
          width: 100%;
          min-height: 80px;
          font-size: 15px;
          font-family: 'Prompt', sans-serif;
          background-color: #f9f9f9;
          resize: vertical;
          box-sizing: border-box;
        }

        .img-container {
          display: flex;
          justify-content: center; 
        }

        .slip-img {
          width: 70%;
          height: auto;
          border-radius: 6px;
          margin-top: 10px;
        }

        .slip-btn{
          text-align: center;
          text-decoration: none;
          font-size: 15px;
          padding: 10px;
          background-color: #4CAF50;
          color: white;
          border-radius: 6px;
          cursor: pointer;
          
        }

        /* left container */
        .left-container {
          background-color: var(--card-bg-color);
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
          flex: 1;
          display: flex;
          flex-direction: column;
          align-items: stretch;
          height: 90vh;
          gap: 10px;
        }

      .show-list {
          overflow-y: auto;   /* สร้าง scroll แนวตั้งเมื่อเนื้อหายาว */
          min-height: 0;      /* ป้องกัน flexbox ขยายเกิน */
        }

        .show-list::-webkit-scrollbar {
          width: 8px;
        }
        .show-list::-webkit-scrollbar-thumb {
          background-color: rgba(0, 0, 0, 0.2);
          border-radius: 4px;
        }

        .student-list-item {
          border: 1px solid #ddd;
          padding: 8px;
          margin-bottom: 8px;
          background-color: #fff;
          border-radius: 6px;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        .student-list-item:hover {
          background-color: #f0f0f0;
        }

        .student-list-item button {
          font-size: 14px;
          padding: 6px 12px;
          border-radius: 4px;
          background-color: #007bff;
          color: white;
          border: none;
          cursor: pointer;
        }

        .student-list-item button:hover {
          background-color: #0056b3;
        }


        /* filter */
        .filter-section{
          display: flex;
          flex-direction: row;
          margin-bottom: 12px;
          align-items: center;
          gap: 12px; 
        }

        .filter-section label {
          font-weight: 600;
          color: var(--text-color);
          margin-bottom: 4px;
        }

        .sort-box {
          padding: 8px 12px;
          border: 1px solid var(--input-border-color);
          border-radius: 8px;
          background-color: var(--input-bg-color);
          font-size: 14px;
          width: 100%;
          max-width: 100%;
          transition: border-color 0.3s;
        }

        .sort-box:focus {
          outline: none;
          border-color: #007BFF;
        }

        
        #majorFilterContainer, #statusFilterContainer {
          display: none;
        }
        .reset-btn{
          padding: 10px;
          background-color: #007BFF;
          border-radius: 5px;
          color: #fff;
          border: none;
          font-size: 14px;
          cursor: pointer;
          transition: background-color 0.3s;
        }
        .student-count{
          font-weight: bold;
          font-size: large;
          margin-top: 8px;
        }

        button:hover {
          background-color: #0056b3;
        }
        .student-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .student-card h3 {
            margin-bottom: 10px;
        }
        @media (max-width: 780px) {
            .container {
                width: 100%;
            }
            .warp-container {
                flex-direction: column;
                height: auto;
            }
            .left-container, .right-container {
                width: 100%;
                flex: none;
                overflow-y: auto;
                height: 100vh;
                /* height: 500px; */
            }
            .info-card {
                height: auto;
            }
            .nav {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            .nav h1 {
                font-size: 20px;
            }
            .search-card form {
                flex-direction: column;
            }
            .submit-btn {
                width: 100%;
            }
            .filter-section{
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              gap: 1px;
            }
            .student-count{
              text-align: center;
            }

        }
    </style>
</head>
<body>
  <div id="toast" class="toast"></div>
    <div class="container">
    <div class="nav">
      <h1>ADMIN DASHBOARD</h1>
      <h1>SMO, Informatics Buu</h1>
    </div>

    <div class="warp-container">
      <div class="left-container">
        <div class="filter-section">
          <label for="yearFilter">ปี:</label>
          <select class="sort-box" id="yearFilter" onchange="applyFilters()">
            <option value="all">ทุกชั้นปี</option>
            <option value="64">64</option>
            <option value="65">65</option>
            <option value="66">66</option>
            <option value="67">67</option>
            <option value="68">68</option>
          </select>

          <label for="majorFilter">สาขา:</label>
          <select class="sort-box" id="majorFilter" onchange="applyFilters()">
            <option value="all">ทุกสาขา</option>
            <option value="ITDI">ITDI</option>
            <option value="SE">SE</option>
            <option value="CS">CS</option>
            <option value="AAI">AAI</option>
          </select>

          <label for="statusFilter">สถานะ:</label>
          <select class="sort-box" id="statusFilter" onchange="applyFilters()">
            <option value="all">ทุกสถานะ</option>
            <option value="รอรับ">รอรับ</option>
            <option value="จัดส่งสำเร็จ">จัดส่งสำเร็จ</option>
            <option value="มีปัญหา">มีปัญหา</option>
            <option value="รอตรวจสอบ">รอตรวจสอบ</option>
          </select>
        </div>


        <button class="reset-btn" onclick="resetFilters()">รีเซ็ต</button>
        <div class="student-count" id="studentCount">
          แสดงทั้งหมด 0 รายการ
        </div>
        <div class="show-list">
          <div id="leftContainer"></div>
        </div>
      </div>

      <div class="right-container"> 
        <div class="search-card">
          <div class="search-box">
            <h2 class="search-title">ค้นหาด้วยรหัสนิสิตหรือชื่อ</h2>
            <form autocomplete="off" onsubmit="readData(event)">
              <input autocomplete="none" type="text" id="studentIdInput" placeholder="รหัสนิสิตหรือชื่อ">
              <button class="submit-btn" type="submit">ค้นหา</button>
            </form>
          </div>
        </div>

        <div class="info-card">
          <div class="detail-content" id="detailContent">
            <h2>ข้อมูลนิสิต</h2>
            <div class="student-items" id="studentDetails">
              <!-- <div class="student-card">
                <div class="student-details">
                  <p><strong>รหัสนิสิต:</strong> ${studentId}</p>
                  <p><strong>ชื่อ:</strong> ${firstName}</p>
                  <p><strong>สาขา:</strong> ${major}</p>
                  <p><strong>เสื้อไซด์:</strong> ${size} <strong>จำนวน</strong> ${total} ตัว</p>
                  <p><strong>หมายเหตุ:</strong> ${notice}</p>
                  <p><strong>หมายเหตุเพิ่มเติม:</strong> ${noticeMore}</p>
                  <p><strong>เบอร์ติดต่อ:</strong> ${tel}</p>
                  <div class="status-control">
                    <label><strong>สถานะ:</strong></label>
                    <select id="statusSelect_${studentId}_${sheetIndex}"
                    onchange="handleStatusChange(this, '${studentId}', '${sheetIndex}')">
                    <option value="" disabled selected>กำลังโหลด...</option>
                    <option value="รอรับ">รอรับ</option>
                    <option value="รอตรวจสอบ">รอตรวจสอบ</option>
                    <option value="จัดส่งสำเร็จ">จัดส่งสำเร็จ</option>
                    <option value="มีปัญหา">มีปัญหา</option>
                  </select>
                  <label for="problemText_${studentId}_${sheetIndex}" style="display: none;">ระบุปัญหาที่พบ:</label>
                  <textarea id="problemText_${studentId}_${sheetIndex}" class="problem-textarea" placeholder="โปรดระบุปัญหา"
                  style="display:none;">${problemTextValue}</textarea>
                  <button onclick="updateStatus('${studentId}', '${sheetIndex}')">บันทึกสถานะ</button>
                  <div class="img-container">
                    <img class="slip-img"src="https://drive.google.com/thumbnail?id=1v42DgM3X5jTedKSX5gP7_rYBJu9uHfd2&sz=w1000">
                  </div>
                    <a class="slip-btn" target="_blank" href="${linkDrive}">กดเพื่อตรวจสอบสลิป</a>
                  </div>
                </div>
              </div> -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>

    let allStudentData = [];
    let studentMap = new Map();

    // Load data when the page opens
    window.onload = function () {
      google.script.run.withSuccessHandler(function (data) {
        allStudentData = data.slice(1);
        data.slice(1).forEach((row, index) => {
          const rawId = row[2];
          const formattedId = rawId ? Number(rawId).toFixed(0) : '';
          const sheetRowIndex = index + 2;
          if (!studentMap.has(formattedId)) {
            studentMap.set(formattedId, []);
          }
          studentMap.get(formattedId).push({ data: row, sheetIndex: sheetRowIndex });
        });
        renderStudentList(allStudentData);
        showMessage("โหลดข้อมูลทั้งหมดเรียบร้อยแล้ว", "success");
      }).getAllStudents();
    };


    function showMessage(message, type = 'info', duration = 3000) {
      const toast = document.getElementById('toast');
      toast.className = 'toast ' + type;
      toast.textContent = message;

      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    function getDriveFileId(linkDrive) {
      if (!linkDrive) return "";

      // ตรวจสอบลิงก์แบบ /d/FILE_ID/
      let match = linkDrive.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match && match[1]) return match[1];

      // ตรวจสอบลิงก์แบบ ?id=FILE_ID
      match = linkDrive.match(/id=([a-zA-Z0-9_-]+)/);
      if (match && match[1]) return match[1];

      return "";
    }

    function displayStudentDetails(studentData, sheetIndex) {
      const studentId = studentData[2] || '-';
      const firstName = studentData[4] || '-';
      const major = studentData[5] || '-';
      const tel = studentData[6] || '-';
      const size = studentData[7] || '-';
      const total = studentData[8] || '-';
      const notice = studentData[10] || '';
      const linkDrive = studentData[11] || "www.google.com";
      const problemTextValue = studentData[14] || '';
      const statusValue = studentData[13] || '';
      const noticeMore = studentData[12] || '-';

      const fileId = getDriveFileId(linkDrive);
      const thumbnailHtml = fileId 
          ? `<img class="slip-img" src="https://drive.google.com/thumbnail?id=${fileId}&sz=w1000" alt="Slip Image">`
          : `<p>ไม่มีสลิป</p>`;

      const wrapper = document.createElement("div");
      wrapper.classList.add("student-card");

      const htmlContent = `
        <div class="student-details">
          <p><strong>รหัสนิสิต:</strong> ${studentId}</p>
          <p><strong>ชื่อ:</strong> ${firstName}</p>
          <p><strong>สาขา:</strong> ${major}</p>
          <p><strong>เสื้อไซด์:</strong> ${size} <strong>จำนวน</strong> ${total} ตัว</p>
          <p><strong>หมายเหตุ:</strong> ${notice}</p>
          <p><strong>หมายเหตุเพิ่มเติม:</strong> ${noticeMore}</p>
          <p><strong>เบอร์ติดต่อ:</strong> ${tel}</p>
          <div class="img-container">
              ${thumbnailHtml}
          </div>
          <a class="slip-btn" target="_blank" href="${linkDrive}">กดเพื่อตรวจสอบสลิป</a>
          <div class="status-control">
            <label><strong>สถานะ:</strong></label>
            <select id="statusSelect_${studentId}_${sheetIndex}"
              onchange="handleStatusChange(this, '${studentId}', '${sheetIndex}')">
              <option value="" disabled selected>กำลังโหลด...</option>
              <option value="รอรับ">รอรับ</option>
              <option value="รอตรวจสอบ">รอตรวจสอบ</option>
              <option value="จัดส่งสำเร็จ">จัดส่งสำเร็จ</option>
              <option value="มีปัญหา">มีปัญหา</option>
            </select>
            <label for="problemText_${studentId}_${sheetIndex}" style="display: none;">ระบุปัญหาที่พบ:</label>
            <textarea id="problemText_${studentId}_${sheetIndex}" class="problem-textarea" placeholder="โปรดระบุปัญหา"
              style="display:none;">${problemTextValue}</textarea>
            <button onclick="updateStatus('${studentId}', '${sheetIndex}')">บันทึกสถานะ</button>

          </div>
        </div>
      `;

      wrapper.innerHTML = htmlContent;
      return wrapper;
    }

    // Function to handle errors
    function handleError(error) {
      console.error('Error:', error);
      showMessage('card: ' + error.message, 'error');
      document.getElementById('studentDetails').innerHTML = '<p style="color: red;">เกิดข้อผิดพลาดในการค้นหา</p>';
    }

    // Update status in Google Sheet and UI
    function updateStatus(studentId, sheetIndex) {
      const selectedStatus = document.getElementById(`statusSelect_${studentId}_${sheetIndex}`).value;
      const problemText = document.getElementById(`problemText_${studentId}_${sheetIndex}`).value;

      if (!selectedStatus) {
        showMessage('กรุณาเลือกสถานะก่อนบันทึก', 'error');
        return;
      }

      showMessage('กำลังอัปเดตสถานะ...', 'info');

      google.script.run
        .withSuccessHandler(() => {
          // Update the local data array
          const localIndex = sheetIndex - 2; // Convert sheet row index to 0-based array index
          if (localIndex >= 0 && localIndex < allStudentData.length) {
            allStudentData[localIndex][13] = selectedStatus;
            allStudentData[localIndex][14] = problemText;
          }
          // Re-render the left container to show the updated status
          applyFilters();
          showMessage('อัปเดตสถานะสำเร็จ', 'success');
        })
        .withFailureHandler(err => {
          showMessage('เกิดข้อผิดพลาด: ' + err.message, 'error');
        })
        .updateStudentStatus(sheetIndex, selectedStatus, problemText);
    }

    // Show/hide problem textarea based on selected status
    function handleStatusChange(select, studentId, sheetIndex) {
      const problemText = document.getElementById(`problemText_${studentId}_${sheetIndex}`);
      const problemLabel = problemText.previousElementSibling;
      if (select.value === 'มีปัญหา') {
        problemText.style.display = 'block';
        problemLabel.style.display = 'block';
      } else {
        problemText.style.display = 'none';
        problemLabel.style.display = 'none';
      }
    }

    // Update the UI with status and problem text loaded from sheet
    function updateStatusInUI(status, problemTextValue, studentId, sheetIndex) {
      const select = document.getElementById(`statusSelect_${studentId}_${sheetIndex}`);
      const problemText = document.getElementById(`problemText_${studentId}_${sheetIndex}`);
      const problemLabel = problemText.previousElementSibling;

      if (!select) return;

      select.value = status || "";
      problemText.value = problemTextValue || "";

      if (status === "มีปัญหา") {
        problemText.style.display = "block";
        problemLabel.style.display = "block";
      } else {
        problemText.style.display = "none";
        problemLabel.style.display = "none";
      }
    }

    // Load student data and status by ID
    function loadStudentById(studentId) {
      const studentDataArray = studentMap.get(studentId);
      const studentDetailDiv = document.getElementById('studentDetails');
      studentDetailDiv.innerHTML = '';

      if (studentDataArray && studentDataArray.length > 0) {
        studentDataArray.forEach(item => {
          const studentData = item.data;
          const sheetIndex = item.sheetIndex;
          const detailCard = displayStudentDetails(studentData, sheetIndex);
          studentDetailDiv.appendChild(detailCard);

          google.script.run
            .withSuccessHandler(function (statusData) {
              updateStatusInUI(statusData.status, statusData.problem, studentId, sheetIndex);
            })
            .withFailureHandler(handleError)
            .getStatusByStudentId(sheetIndex);
        });

        showMessage(`พบข้อมูล ${studentDataArray.length} รายการสำหรับรหัสนี้`, "success", 5000);
      } else {
        showMessage('ไม่พบข้อมูลสำหรับรหัสนิสิตนี้', 'error');
      }
    }

    // Load and render student list
    function renderStudentList(dataRows) {
      const leftContainer = document.getElementById('leftContainer');
      leftContainer.innerHTML = '';

      const sortedData = [...dataRows].sort((a, b) => {
        const idA = a[2] ? parseInt(a[2], 10) : 0;
        const idB = b[2] ? parseInt(b[2], 10) : 0;
        return idA - idB;
      });

      sortedData.forEach(row => {
        const rawId = row[2];
        const formattedId = rawId ? Number(rawId).toFixed(0) : '';
        const name = row[4] || '-';
        const status = row[13] || 'รอรับ'; // Assuming column 14 (index 13) is status
        if (!formattedId) return;

        const studentItem = document.createElement('div');
        studentItem.classList.add('student-list-item');
        studentItem.innerHTML = `
          <div>
            <strong>${formattedId}</strong><br>
            <span>${name}</span><br>
            <small>สถานะ: ${status}</small>
          </div>
        `;
        const button = document.createElement('button');
        button.textContent = 'ตรวจสอบ';
        button.addEventListener('click', () => {
          loadStudentById(formattedId);
        });

        studentItem.appendChild(button);
        leftContainer.appendChild(studentItem);
      });

        document.getElementById("studentCount").textContent = `แสดงทั้งหมด ${sortedData.length} รายการ`;
    }

    //filter function
    // Get major abbreviation from full name
    function getMajorAbbreviation(fullMajorName) {
      if (!fullMajorName) return '';
      fullMajorName = fullMajorName.trim();
      if (fullMajorName.includes('เทคโนโลยีสารสนเทศ')) return 'ITDI';
      if (fullMajorName.includes('ซอฟต์แวร์')) return 'SE';
      if (fullMajorName.includes('วิทยาการคอมพิวเตอร์')) return 'CS';
      if (fullMajorName.includes('ปัญญาประดิษฐ์')) return 'AAI';
      return '';
    }

    function applyFilters() {
      const selectedYear = document.getElementById("yearFilter").value;
      const selectedMajor = document.getElementById("majorFilter").value;
      const selectedStatus = document.getElementById("statusFilter").value;

      let filtered = [...allStudentData];

      // กรองตามปี
      if (selectedYear !== "all") {
        filtered = filtered.filter(row => {
          const rawId = row[2] ? row[2].toString() : "";
          return rawId.startsWith(selectedYear);
        });
      }

      // กรองตามสาขา
      if (selectedMajor !== "all") {
        filtered = filtered.filter(row => {
          const abbrev = getMajorAbbreviation(row[5]);
          return abbrev === selectedMajor;
        });
      }

      // กรองตามสถานะ
      if (selectedStatus !== "all") {
        filtered = filtered.filter(row => (row[13] || "") === selectedStatus);
      }

      renderStudentList(filtered);
    }



    // Reset all filters and show full list
    function resetFilters() {
      // รีเซ็ตค่า filter
      document.getElementById("yearFilter").value = "all";
      document.getElementById("majorFilter").value = "all";
      document.getElementById("statusFilter").value = "all";

      // โหลดข้อมูลล่าสุดจาก Google Sheet
      google.script.run.withSuccessHandler(function(data) {
        allStudentData = data.slice(1); // ตัด header ออก
        studentMap.clear(); // เคลียร์ map ก่อน
        data.slice(1).forEach((row, index) => {
          const rawId = row[2];
          const formattedId = rawId ? Number(rawId).toFixed(0) : '';
          const sheetRowIndex = index + 2;
          if (!studentMap.has(formattedId)) {
            studentMap.set(formattedId, []);
          }
          studentMap.get(formattedId).push({ data: row, sheetIndex: sheetRowIndex });
        });
        renderStudentList(allStudentData);
        showMessage("รีเซ็ตฟิลเตอร์และโหลดข้อมูลล่าสุดเรียบร้อยแล้ว", "success");
      }).getAllStudents();
    }

    // Search function for student ID or name 
    function readData(event) {
      event.preventDefault();
      const input = document.getElementById('studentIdInput').value.trim();
      const keyword = input.toLowerCase();

      if (!keyword) {
        showMessage('กรุณาป้อนรหัสนิสิตหรือชื่อ', 'error');
        document.getElementById('studentDetails').innerHTML = '<p>กรุณาป้อนข้อมูลเพื่อค้นหา</p>';
        return;
      }

      showMessage('กำลังค้นหา...', 'info');

      // Search by student ID
      const studentById = studentMap.get(keyword);
      if (studentById) {
        loadStudentById(keyword);
        return;
      }

      // If not found by ID, search by name
      const foundStudents = allStudentData.filter(row => {
        const name = row[4] ? row[4].toLowerCase() : '';
        return name.includes(keyword);
      });

      if (foundStudents.length > 0) {
        const studentDetailDiv = document.getElementById('studentDetails');
        studentDetailDiv.innerHTML = '';
        foundStudents.forEach(studentData => {
            const sheetIndex = allStudentData.indexOf(studentData) + 2; // หา index สำหรับ sheet
            const detailCard = displayStudentDetails(studentData, sheetIndex);
            studentDetailDiv.appendChild(detailCard);

            google.script.run
                .withSuccessHandler(function (statusData) {
                    updateStatusInUI(statusData.status, statusData.problem, studentData[2], sheetIndex);
                })
                .withFailureHandler(handleError)
                .getStatusByStudentId(sheetIndex);
        });

        showMessage(`พบข้อมูล ${foundStudents.length} รายการสำหรับชื่อที่ค้นหา`, "success", 5000);
        } else {
          showMessage('ไม่พบข้อมูลที่ค้นหา', 'error');
          document.getElementById('studentDetails').innerHTML = '<p style="color:red;">ไม่พบข้อมูล</p>';
        }
    }

  </script>
</body>
</html>